<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YouTube ‚Üí MP3 | Conversor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #0f172a; color: #f8fafc; font-family: system-ui, sans-serif; }
    .card { background-color: #1e293b; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    .status-banner { text-align:center; padding:0.5rem; font-weight:600; border-radius:0.5rem; margin-bottom:1rem; }
    .loading-bar {
      position: relative;
      width: 100%;
      height: 6px;
      background-color: #334155;
      border-radius: 10px;
      overflow: hidden;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .loading-bar.active { opacity: 1; }
    .loading-bar::after {
      content: "";
      position: absolute;
      width: 40%;
      height: 100%;
      background: linear-gradient(90deg, #38bdf8, #3b82f6, #38bdf8);
      border-radius: 10px;
      animation: moveBar 1.2s infinite linear;
    }
    @keyframes moveBar {
      0% { left: -40%; }
      100% { left: 100%; }
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

  <main class="card w-full max-w-2xl space-y-4">
    <div id="backendStatus" class="status-banner bg-slate-700 text-slate-200">Verificando conexi√≥n...</div>

    <h1 class="text-3xl font-bold text-center text-sky-400">üéß Conversor YouTube ‚Üí MP3</h1>
    <p class="text-slate-300 text-center">Pega tus enlaces de YouTube (uno por l√≠nea) y convierte tus MP3 con car√°tula y metadatos.</p>

    <textarea id="urls" rows="6" class="w-full rounded-lg p-2 text-black" placeholder="https://www.youtube.com/watch?v=..."></textarea>

    <div class="flex gap-3 justify-center">
      <button id="btnConvert" class="bg-sky-500 hover:bg-sky-600 px-4 py-2 rounded-lg font-semibold">Convertir</button>
      <button id="btnDownload" class="bg-emerald-500 hover:bg-emerald-600 px-4 py-2 rounded-lg font-semibold hidden">Descargar</button>
    </div>

    <div id="loadingBar" class="loading-bar mt-2"></div>
    <div id="status" class="text-center text-slate-400 text-sm mt-2"></div>
  </main>

  <script>
    const API = "__BACKEND_URL__";

    const btnConvert = document.getElementById("btnConvert");
    const btnDownload = document.getElementById("btnDownload");
    const statusDiv = document.getElementById("status");
    const backendStatus = document.getElementById("backendStatus");
    const loadingBar = document.getElementById("loadingBar");

    let downloadBlob = null;
    let downloadFilename = "descarga";

    async function checkBackend() {
      const start = performance.now();
      try {
        const res = await fetch(`${API}/health`);
        const latency = Math.round(performance.now() - start);
        if (res.ok) {
          backendStatus.textContent = `‚úÖ Conectado (${latency} ms)`;
          backendStatus.classList.remove("bg-rose-600", "bg-amber-500");
          backendStatus.classList.add(latency < 300 ? "bg-emerald-600" :
                                      latency < 800 ? "bg-amber-500" :
                                      "bg-rose-600");
        } else throw new Error("no ok");
      } catch {
        backendStatus.textContent = "‚ùå Backend no disponible";
        backendStatus.classList.remove("bg-emerald-600", "bg-amber-500");
        backendStatus.classList.add("bg-rose-600");
      }
    }
    checkBackend();

    function getUrls() {
      return document.getElementById("urls").value.trim().split(/\r?\n/).filter(Boolean);
    }

    async function convertir() {
      const urls = getUrls();
      if (!urls.length) return alert("Pega al menos una URL de YouTube");

      statusDiv.textContent = "Procesando tus enlaces, por favor espera...";
      loadingBar.classList.add("active");
      btnDownload.classList.add("hidden");
      downloadBlob = null;

      try {
        const res = await fetch(`${API}/convert`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ urls })
        });

        if (!res.ok) {
          const e = await res.json().catch(() => ({ detail: res.statusText }));
          statusDiv.textContent = "‚ùå Error: " + e.detail;
          loadingBar.classList.remove("active");
          return;
        }

        const blob = await res.blob();
        const cd = res.headers.get("content-disposition") || "";
        downloadFilename = (cd.match(/filename="?([^"]+)"?/) || [null, "descarga"]).pop();
        downloadBlob = blob;

        statusDiv.textContent = "‚úÖ Conversi√≥n completada. Listo para descargar.";
        btnDownload.classList.remove("hidden");
      } catch (err) {
        statusDiv.textContent = "‚ùå Error: " + err.message;
      } finally {
        loadingBar.classList.remove("active");
      }
    }

    function descargar() {
      if (!downloadBlob) return;
      const url = URL.createObjectURL(downloadBlob);
      const a = document.createElement("a");
      a.href = url;
      a.download = downloadFilename;
      a.click();
      URL.revokeObjectURL(url);
    }

    btnConvert.onclick = convertir;
    btnDownload.onclick = descargar;
  </script>
</body>
</html>
