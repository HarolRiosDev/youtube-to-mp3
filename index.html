<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YouTube ‚Üí MP3 | Conversor Personal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #0f172a; color: #f8fafc; font-family: system-ui, sans-serif; }
    .card { background-color: #1e293b; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    .progress-bar { height: 6px; background-color: #334155; border-radius: 1rem; overflow: hidden; }
    .progress-bar-inner { height: 100%; background-color: #38bdf8; width: 0%; transition: width 0.3s; }
    .status-banner { text-align:center; padding:0.5rem; font-weight:600; border-radius:0.5rem; margin-bottom:1rem; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

  <main class="card w-full max-w-2xl space-y-4">
    <div id="backendStatus" class="status-banner bg-slate-700 text-slate-200">Verificando conexi√≥n...</div>

    <h1 class="text-3xl font-bold text-center text-sky-400">üéß Conversor YouTube ‚Üí MP3</h1>
    <p class="text-slate-300 text-center">Pega tus enlaces de YouTube (uno por l√≠nea) y descarga tus MP3 con car√°tula y metadatos.</p>

    <textarea id="urls" rows="6" class="w-full rounded-lg p-2 text-black" placeholder="https://www.youtube.com/watch?v=..."></textarea>

    <div class="flex gap-3 justify-center">
      <button id="btnConvert" class="bg-sky-500 hover:bg-sky-600 px-4 py-2 rounded-lg font-semibold">Descargar MP3</button>
      <button id="btnStream" class="bg-emerald-500 hover:bg-emerald-600 px-4 py-2 rounded-lg font-semibold">Modo Streaming</button>
    </div>

    <div id="status" class="text-center text-slate-400 text-sm"></div>

    <div id="progressContainer" class="space-y-3"></div>
  </main>

  <script>
    // üß© Esta constante se sustituye autom√°ticamente por GitHub Actions
    const API = "__BACKEND_URL__";

    const btnConvert = document.getElementById("btnConvert");
    const btnStream = document.getElementById("btnStream");
    const statusDiv = document.getElementById("status");
    const progressContainer = document.getElementById("progressContainer");
    const backendStatus = document.getElementById("backendStatus");

    // üö¶ Verificar conexi√≥n + latencia
    async function checkBackend() {
      const start = performance.now();
      try {
        const res = await fetch(`${API}/health`);
        const latency = Math.round(performance.now() - start);
        if (res.ok) {
          backendStatus.textContent = `‚úÖ Conectado (${latency} ms)`;
          backendStatus.classList.remove("bg-rose-600", "bg-amber-500");
          backendStatus.classList.add(latency < 300 ? "bg-emerald-600" :
                                      latency < 800 ? "bg-amber-500" :
                                      "bg-rose-600");
        } else throw new Error("no ok");
      } catch {
        backendStatus.textContent = "‚ùå Backend no disponible";
        backendStatus.classList.remove("bg-emerald-600", "bg-amber-500");
        backendStatus.classList.add("bg-rose-600");
      }
    }
    checkBackend();

    function getUrls() {
      return document.getElementById("urls").value.trim().split(/\r?\n/).filter(Boolean);
    }

    function createProgressItem(url) {
      const el = document.createElement("div");
      el.className = "p-2 rounded-lg bg-slate-800";
      el.innerHTML = `
        <div class="text-xs text-sky-300 truncate">${url}</div>
        <div class="progress-bar mt-1"><div class="progress-bar-inner"></div></div>
        <div class="text-xs mt-1 text-slate-400">Esperando...</div>
      `;
      progressContainer.appendChild(el);
      return el;
    }

    function updateProgress(el, text) {
      const bar = el.querySelector(".progress-bar-inner");
      const label = el.querySelector("div.text-xs.mt-1");
      label.textContent = text;
      const match = text.match(/(\d+(\.\d+)?)%/);
      if (match) bar.style.width = match[1] + "%";
      if (text.includes("100%") || text.toLowerCase().includes("listo")) bar.style.width = "100%";
    }

    async function convertirDirecto() {
      const urls = getUrls();
      if (!urls.length) return alert("Pega al menos una URL");
      statusDiv.textContent = "Procesando...";
      progressContainer.innerHTML = "";

      const res = await fetch(`${API}/convert`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ urls })
      });

      if (!res.ok) {
        const e = await res.json().catch(() => ({ detail: res.statusText }));
        statusDiv.textContent = "Error: " + e.detail;
        return;
      }

      // üîΩ Descarga autom√°tica del MP3 o ZIP
      const blob = await res.blob();
      const cd = res.headers.get("content-disposition") || "";
      const fname = (cd.match(/filename="?([^"]+)"?/) || [null, "descarga"]).pop();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = fname; a.click();
      URL.revokeObjectURL(url);

      statusDiv.textContent = "‚úÖ Descarga completada";
    }

    async function convertirStream() {
      const urls = getUrls();
      if (!urls.length) return alert("Pega al menos una URL");
      statusDiv.textContent = "Procesando (modo streaming)...";
      progressContainer.innerHTML = "";

      const progressItems = {};
      urls.forEach(u => progressItems[u] = createProgressItem(u));

      const res = await fetch(`${API}/convert/stream`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ urls })
      });

      const reader = res.body.getReader();
      const decoder = new TextDecoder();

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value, { stream: true });

        for (const line of chunk.split("\n\n")) {
          if (!line.startsWith("data: ")) continue;
          try {
            const msg = JSON.parse(line.slice(6));
            const el = progressItems[msg.url];
            if (!el) continue;
            if (msg.progress) updateProgress(el, msg.progress);
            if (msg.done) updateProgress(el, "‚úÖ Listo: " + msg.done);
            if (msg.error) updateProgress(el, "‚ùå Error: " + msg.error);
          } catch (err) {
            console.warn("Mensaje SSE inv√°lido:", line);
          }
        }
      }

      statusDiv.textContent = "‚úÖ Procesamiento completado";
    }

    btnConvert.onclick = convertirDirecto;
    btnStream.onclick = convertirStream;
  </script>
</body>
</html>
